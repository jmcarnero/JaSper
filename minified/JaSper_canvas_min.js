/*! JaSper v3.5 | (c) 2015 Jos√© M. Carnero (sargazos.net) | JaSper_canvas v1.0 */
JaSper.extend(JaSper.prototype,{canvas:function(){"use strict";var a=function(a,b){a.each(function(){return!!JaSper.canvas.valid(this)&&(this.JaSperItemSelected=void 0,void 0===this.JaSperItems&&(this.JaSperItems=[]),this.JaSperItems.flags=this.JaSperItems.flags||{},this.JaSperItems.flags.animable=this.JaSperItems.flags.animable||!1,this.JaSperItems.flags.draggable=this.JaSperItems.flags.draggable||!1,JaSper.canvas.add(this,b),!1)},b)};for(var b in arguments){var c=!1;try{c=Object.keys(arguments[b])[0]}catch(a){}if(c===!1)return JaSper.log("-JaSper::canvas- id de objeto invalida",2),!1;a(this,arguments[b][c])}return this},animate:function(){"use strict";var a=arguments;return this.each(function(){return"canvas"!=this.nodeName.toLowerCase()?(JaSper.log("-JaSper::animate- el objeto no es canvas",1),!1):(this.JaSperItems.flags.animable=!0,JaSper.canvas.animate(this,a))},a),this}}),JaSper.canvas={add:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;b.id=b.id||JaSper.funcs.genId();var c={background:"background",circle:"circle",image:"image",path:"path",polygon:"polygon",text:"text"};if(!b.func||!JaSper.canvas[b.func]&&!c[b.func])return JaSper.log("-JaSper::canvas.add- metodo desconocido",2),!1;void 0!==c[b.func]&&(b.func=c[b.func]),a.JaSperItems[b.id]=b;var d=JaSper.canvas[b.func];return"function"==typeof d&&(void 0!=b.drag&&b.drag&&!a.JaSperItems.flags.draggable&&(a.JaSperItems.flags.draggable=!0,JaSper.event.add(a,"mousedown",JaSper.canvas.mouseDown)),d.call(null,a,b))},animate:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;window.requestAnimationFrame(function(){JaSper.canvas.animate(a,b)});var c=function(a,b){var c=JaSper.canvas[b.func];return"function"==typeof c&&c.call(null,a,b)},d={move:"move",scale:!1};for(var e in b){var f=!1;try{f=Object.keys(b[e])[0]}catch(a){}if(!(void 0!==b[e][f].frames&&b[e][f].frames--<1)){var g=b[e][f];if(f===!1||void 0===d[f])return JaSper.log("-JaSper::canvas.animate- submetodo desconocido: "+b[e],2),!1;if(d[f]!==!1)g.func=d[f],c(a,g);else switch(f){case"scale":if(!g.id||!a.JaSperItems[g.id])return!1;void 0===a.JaSperItems[g.id].scaleX&&(a.JaSperItems[g.id].scaleX=0),void 0===a.JaSperItems[g.id].scaleY&&(a.JaSperItems[g.id].scaleY=0);var h=g.scaleX||0,i=g.scaleY||0,j=g.speed||1;"function"==typeof g.speed&&(j=g.speed.call(null)),a.JaSperItems[g.id].scaleX+=h*j,a.JaSperItems[g.id].scaleY+=i*j;break;default:return JaSper.log("-JaSper::canvas.animate- submetodo desconocido: "+f,2),!1}}}JaSper.canvas.redraw(a)},background:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;var c=a.getContext("2d");return b.fillStyle=b.fillStyle||"#fff",b.width=b.width||a.style.width||!1,b.height=b.height||a.style.height||!1,b.width&&(a.width=b.width),b.height&&(a.height=b.height),c.fillStyle=b.fillStyle,c.fillRect(0,0,a.width,a.height),!0},boundingBox:function(a,b){"use strict";if(!JaSper.canvas.valid(a)||!b.boundingBox)return!1;var c=a.getContext("2d"),d=2;if(b.selected){var e=b.boundingBox[0]-d,f=b.boundingBox[1]-d,g=b.boundingBox[2]+2*d,h=b.boundingBox[3]+2*d;c.save(),c.beginPath(),c.rect(e,f,g,h),c.lineWidth=1,c.strokeStyle="green",c.stroke(),c.beginPath(),c.lineWidth=1,c.strokeStyle="yellow";var i=5,j=3.3;c.moveTo(e+i*Math.sin(j),f-i*Math.cos(j));var k=2*Math.PI/3;c.lineTo(e+i*Math.sin(j+k),f-i*Math.cos(j+k)),c.lineTo(e+i*Math.sin(j+k+k),f-i*Math.cos(j+k+k)),c.stroke(),j=.22,c.moveTo(e+g+i*Math.sin(j),f+h-i*Math.cos(j)),k=2*Math.PI/3,c.lineTo(e+g+i*Math.sin(j+k),f+h-i*Math.cos(j+k)),c.lineTo(e+g+i*Math.sin(j+k+k),f+h-i*Math.cos(j+k+k)),c.stroke(),c.beginPath(),c.arc(e+g,f,i,Math.PI/180*0,Math.PI/180*270),c.stroke(),c.closePath(),c.restore()}return!0},circle:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;var c=a.getContext("2d");b.r=b.r||50,b.x=b.x||100,b.y=b.y||100,b.angleStart=b.angleStart||0,b.angleEnd=b.angleEnd||360,b.cclock=b.cclock||!1,b.fill=b.fill||"#ccc",b.borderWidth=b.borderWidth||1,b.border=b.border||"#3ab";var d=b.x,e=b.y;return c.save(),void 0===b.scaleX&&void 0===b.scaleY&&void 0===b.rotation||(c.translate(b.x,b.y),d=0,e=0,void 0===b.scaleX&&void 0===b.scaleY||JaSper.canvas.scale(a,b),void 0!==b.rotation&&JaSper.canvas.rotate(a,b)),b.boundingBox=[d-b.r,e-b.r,2*b.r,2*b.r,d+b.r,e+b.r],void 0!=b.selected&&b.selected&&JaSper.canvas.boundingBox(a,b),c.beginPath(),c.arc(d,e,b.r,Math.PI/180*b.angleStart,Math.PI/180*b.angleEnd,b.cclock),c.closePath(),c.fillStyle=b.fill,c.strokeStyle=b.border,c.lineWidth=b.borderWidth,c.stroke(),c.fill(),c.restore(),b.boundingBox[0]=b.x-b.r,b.boundingBox[1]=b.y-b.r,!0},image:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;var c=a.getContext("2d");b.x=b.x||100,b.y=b.y||100,b.src=b.src||"http://sargazos.net/imgs/logo.png";var d=new Image;return d.onload=function(){c.drawImage(d,b.x,b.y)},d.src=b.src,!0},mouseHit:function(a,b,c){"use strict";if(a.selected){var d=5,e=[Math.abs(a.boundingBox[4]-b),Math.abs(a.boundingBox[1]-c)],f=[Math.abs(a.boundingBox[0]-b),Math.abs(a.boundingBox[1]-c)],g=[Math.abs(a.boundingBox[4]-b),Math.abs(a.boundingBox[5]-c)];if(e[0]<d&&e[1]<d)return"r";if(f[0]<d&&f[1]<d)return"nw";if(g[0]<d&&g[1]<d)return"se"}if(a.r){var h=b-a.x,i=c-a.y;return h*h+i*i<a.r*a.r}if(a.boundingBox){var h=a.boundingBox[0]<b&&b<a.boundingBox[4],i=a.boundingBox[1]<c&&c<a.boundingBox[5];return h&&i}return!1},mouseDown:function(a){"use strict";var b=JaSper.event.source(a);if(!JaSper.canvas.valid(b))return!1;JaSper.event.remove(b,"mousedown",JaSper.canvas.mouseDown);for(var c=b.getBoundingClientRect(),d=b.JaSperItems,e=void 0,f=0,g=0,h=function(a){if(!e)return!1;var d=(a.clientX-c.left)*(b.width/c.width),h=(a.clientY-c.top)*(b.height/c.height);if(void 0!==e.dragging&&e.dragging){if("r"==e.dragging){var i=Math.abs(e.boundingBox[4]-d),j=Math.abs(e.boundingBox[1]-h),k=Math.sqrt(i*i+j*j);e.rotation=k}else e.x=d-f,e.y=h-g;b.JaSperItems.flags.animable||JaSper.canvas.redraw(b)}else if(void 0!==e.selected&&e.selected&&e.boundingBox){var l=5,m=d,n=h,o=[e.boundingBox[0],e.boundingBox[1],e.boundingBox[4],e.boundingBox[5]];if(e.rotation){var p=function(a,b,c){var d=Math.sin(c),e=Math.cos(c);a[0]-=b[0],a[1]-=b[1];var f=a[0]*e-a[1]*d,g=a[0]*d+a[1]*e;return[parseInt(f+b[0]),parseInt(g+b[1])]},q=(e.rotation>360?Math.floor(e.rotation%360):e.rotation)*Math.PI/180,r=e.boundingBox[0]+e.boundingBox[2]/2,s=e.boundingBox[1]+e.boundingBox[3]/2,t=p([m,n],[r,s],q);m=t[0],n=t[1];var u=p([o[0],o[1]],[r,s],q);o[0]=u[0],o[1]=u[1],u=p([o[2],o[3]],[r,s],q),o[2]=u[0],o[3]=u[1]}var v=[Math.abs(o[2]-m),Math.abs(o[1]-n)],w=[Math.abs(o[0]-m),Math.abs(o[1]-n)],x=[Math.abs(o[2]-m),Math.abs(o[3]-n)];if(v[0]<l&&v[1]<l)b.style.cursor="crosshair";else if(w[0]<l&&w[1]<l)b.style.cursor="NW-resize";else if(x[0]<l&&x[1]<l)b.style.cursor="SE-resize";else{var y=o[0]<m&&m<o[2],z=o[1]<n&&n<o[3];y&&z?b.style.cursor="pointer":b.style.cursor="default"}}return!0},i=function(a){JaSper.event.remove(window,"mouseup",i);for(var c in d)void 0!==d[c].dragging&&d[c].dragging&&(f=g=0,d[c].dragging=!1);return b.JaSperItems.flags.animable||JaSper.canvas.redraw(b),JaSper.event.add(b,"mousedown",JaSper.canvas.mouseDown),b.style.cursor="default",!0},j=(a.clientX-c.left)*(b.width/c.width),k=(a.clientY-c.top)*(b.height/c.height),l=Object.keys(d),m=l.length;m>=0;--m)if(d[l[m]]&&d[l[m]].drag){var n=JaSper.canvas.mouseHit(d[l[m]],j,k);n?(b.style.cursor="pointer",f=j-d[l[m]].x,g=k-d[l[m]].y,e=d[l[m]],d[l[m]].selected&&(JaSper.event.remove(window,"mousemove",d[l[m]].mouseMove),delete d[l[m]].mouseMove),e.mouseMove=h,JaSper.event.add(window,"mousemove",e.mouseMove),e.selected=!0,e.dragging=n):(d[l[m]].selected&&(JaSper.event.remove(window,"mousemove",d[l[m]].mouseMove),delete d[l[m]].mouseMove),d[l[m]].selected=!1)}return b.JaSperItemSelected=e,JaSper.event.add(window,"mouseup",i),!1},move:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;if(!b.id||!a.JaSperItems[b.id])return!1;var c=b.angle||0;"function"==typeof b.angle&&(c=b.angle.call(null));var d=c*Math.PI/180,e=b.speed||1;return"function"==typeof b.speed&&(e=b.speed.call(null)),a.JaSperItems[b.id].x+=Math.cos(d)*e,a.JaSperItems[b.id].y+=Math.sin(d)*e,!0},path:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;a.getContext("2d");return!0},polygon:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;var c=a.getContext("2d");b.sides=b.sides||3,b.r=b.r||50,b.x=b.x||0,b.y=b.y||0,b.angle=b.angle||0,b.cclock=b.cclock||!1,b.fill=b.fill||"#ccc",b.borderWidth=b.borderWidth||1,b.border=b.border||"#3ab";var d=b.x,e=b.y,f=b.angle*Math.PI/180;c.save(),void 0===b.scaleX&&void 0===b.scaleY&&void 0===b.rotation||(c.translate(b.x,b.y),d=0,e=0,void 0===b.scaleX&&void 0===b.scaleY||JaSper.canvas.scale(a,b),void 0!==b.rotation&&JaSper.canvas.rotate(a,b)),b.boundingBox=[d-b.r,e-b.r,2*b.r,2*b.r,d+b.r,e+b.r],void 0!=b.selected&&b.selected&&JaSper.canvas.boundingBox(a,b),c.beginPath(),c.moveTo(d+b.r*Math.sin(f),e-b.r*Math.cos(f));for(var g=2*Math.PI/b.sides,h=1;h<b.sides;h++)f+=b.cclock?-g:g,c.lineTo(d+b.r*Math.sin(f),e-b.r*Math.cos(f));return c.closePath(),c.fillStyle=b.fill,c.strokeStyle=b.border,c.lineWidth=b.borderWidth,c.fill(),c.stroke(),c.restore(),b.boundingBox[0]=b.x-b.r,b.boundingBox[1]=b.y-b.r,!0},redraw:function(a){"use strict";if(!JaSper.canvas.valid(a))return!1;var b=a.JaSperItems,c=!1;for(c in b){var d=JaSper.canvas[b[c].func];"function"==typeof d&&d.call(null,a,b[c])}return!0},rotate:function(a,b){"use strict";if(!JaSper.canvas.valid(a)||!b)return!1;var c=a.getContext("2d"),d=b.rotation||0,e=d*Math.PI/180;return c.rotate(e),!0},scale:function(a,b){"use strict";if(!JaSper.canvas.valid(a)||!b)return!1;var c=a.getContext("2d"),d=b.scaleX||1,e=b.scaleY||1;return c.scale(d,e),!0},text:function(a,b){"use strict";if(!JaSper.canvas.valid(a))return!1;var c=a.getContext("2d");b.x=b.x||100,b.y=b.y||100,b.fillStyle=b.fillStyle||"#01f",b.font||(b.fontItalic=b.fontItalic||"italic",b.fontWeight=b.fontWeight||"bold",b.fontSize=b.fontSize||"15pt",b.fontName=b.fontName||"Tahoma",b.font=b.fontItalic+" "+b.fontWeight+" "+b.fontSize+" "+b.fontName),b.fillText=b.fillText||"Hello world!";var d=b.x,e=b.y;c.save(),c.fillStyle=b.fillStyle,c.font=b.font;var f=c.measureText(b.fillText).width,g=c.measureText("m").width;return void 0===b.scaleX&&void 0===b.scaleY&&void 0===b.rotation||(c.translate(b.x+f/2,b.y-g/2),d=-(f/2),e=g/2,void 0===b.scaleX&&void 0===b.scaleY||JaSper.canvas.scale(a,b),void 0!==b.rotation&&JaSper.canvas.rotate(a,b)),c.fillText(b.fillText,d,e),b.boundingBox=[d,e-g,f,g,d+f,e],void 0!=b.selected&&b.selected&&JaSper.canvas.boundingBox(a,b),c.restore(),b.boundingBox[0]=b.x,b.boundingBox[1]=b.y-g,!0},valid:function(a){"use strict";return"object"==typeof a&&"function"==typeof a.getContext||(JaSper.log("-JaSper::canvas.valid- el objeto no es canvas",1),!1)}},function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();
